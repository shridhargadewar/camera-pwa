<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>ShriCam PWA</title>
<meta name="theme-color" content="#086788"/>
<link rel="manifest" id="manifest-placeholder">
<style>
/* === Inlined CSS === */
:root{
  --bg:#f7fbfc;--card:#fff;--accent:#086788;--muted:#666;
  --radius:12px;--gap:12px;
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
}
*{box-sizing:border-box}html,body{margin:0;height:100%;background:var(--bg);color:#111}
header{padding:18px 16px 8px;background:linear-gradient(90deg,#0b486b 0%, #086788 100%);
color:#fff;border-bottom-left-radius:14px;border-bottom-right-radius:14px;text-align:center}
header h1{margin:0;font-size:1.15rem}.subtitle{margin:6px 0 0;font-size:.85rem;opacity:.95}
.container{max-width:820px;margin:18px auto;padding:12px;display:grid;gap:16px}
.camera-pane{background:var(--card);border-radius:var(--radius);padding:8px;
box-shadow:0 6px 18px rgba(12,20,30,.07);display:flex;align-items:center;justify-content:center;
min-height:360px;position:relative;overflow:hidden}
video{width:100%;height:auto;max-height:78vh;border-radius:10px;background:#000;object-fit:cover}
.controls{background:var(--card);padding:12px;border-radius:var(--radius);
box-shadow:0 6px 18px rgba(12,20,30,.05)}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}.btn{background:#fff;
border:1px solid #e3e6ea;padding:10px 12px;border-radius:9px;font-weight:600;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff;border-color:rgba(0,0,0,.05)}.btn:disabled{opacity:.55}
.meta{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-bottom:8px;
font-size:.92rem;color:var(--muted)}
textarea{width:100%;min-height:72px;padding:10px;border-radius:10px;border:1px solid #e6eef2;
resize:vertical;font-size:.95rem}
.hint{font-size:.85rem;color:var(--muted);margin-top:8px}.footer{text-align:center;padding:12px;
font-size:.82rem;color:#666}
@media(min-width:820px){.container{grid-template-columns:1fr 420px}.camera-pane{min-height:520px}}
</style>
</head>
<body>
<header>
  <h1>ShriCam — Camera + Location</h1>
  <p class="subtitle">Watermark: time · date · lat/lon · accuracy · place · PIN · note</p>
</header>
<main class="container">
  <section class="camera-pane">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="snapshot" style="display:none;"></canvas>
  </section>
  <section class="controls">
    <div class="row">
      <button id="startCam" class="btn">Start Camera</button>
      <button id="captureBtn" class="btn primary" disabled>Capture Photo</button>
      <button id="downloadBtn" class="btn" disabled>Download</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="includeLocation" checked/> Location</label>
      <label><input type="checkbox" id="includeTimestamp" checked/> Time/Date</label>
    </div>
    <div class="meta">
      <div><b>Lat:</b> <span id="lat">—</span></div>
      <div><b>Lon:</b> <span id="lon">—</span></div>
      <div><b>Acc (m):</b> <span id="acc">—</span></div>
      <div><b>Place:</b> <span id="placename">—</span></div>
      <div><b>PIN:</b> <span id="pincode">—</span></div>
    </div>
    <textarea id="note" placeholder="Editable Note"></textarea>
    <div class="row">
      <button id="getLoc" class="btn">Fetch Location</button>
      <button id="stopCam" class="btn">Stop Camera</button>
    </div>
    <p class="hint">Use over HTTPS → allow camera + location → capture → download.</p>
  </section>
</main>
<footer class="footer"><small>© OpenStreetMap contributors (for reverse geocoding)</small></footer>

<script>
/* === JS Logic === */
const video=document.getElementById("video"),canvas=document.getElementById("snapshot"),
sBtn=document.getElementById("startCam"),stopBtn=document.getElementById("stopCam"),
cBtn=document.getElementById("captureBtn"),dBtn=document.getElementById("downloadBtn"),
gBtn=document.getElementById("getLoc"),latE=document.getElementById("lat"),
lonE=document.getElementById("lon"),accE=document.getElementById("acc"),
placeE=document.getElementById("placename"),pinE=document.getElementById("pincode"),
noteE=document.getElementById("note"),inclLoc=document.getElementById("includeLocation"),
inclTS=document.getElementById("includeTimestamp");
let stream,lastPos,lastPlace;
async function startCam(){try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1});video.srcObject=stream;cBtn.disabled=!1}catch(e){alert("Camera error:"+e)}}
function stopCam(){if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}video.srcObject=null;cBtn.disabled=!0}
function updPosUI(p){lastPos=p;latE.textContent=p.coords.latitude.toFixed(6);
lonE.textContent=p.coords.longitude.toFixed(6);accE.textContent=Math.round(p.coords.accuracy)}
async function revGeo(lat,lon){try{let r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&addressdetails=1`);
let j=await r.json(),a=j.address||{};lastPlace={place:a.city||a.town||a.village||a.state||"",pin:a.postcode||""};
placeE.textContent=lastPlace.place||"—";pinE.textContent=lastPlace.pin||"—"}catch(e){placeE.textContent=pinE.textContent="—"}}
function getLoc(){navigator.geolocation.getCurrentPosition(p=>{updPosUI(p);if(inclLoc.checked)revGeo(p.coords.latitude,p.coords.longitude)},
e=>alert("Location error:"+e.message),{enableHighAccuracy:!0})}
function ts(){let d=new Date;return{date:d.toLocaleDateString(),time:d.toLocaleTimeString()}}
function roundRect(c,x,y,w,h,r){c.beginPath();c.moveTo(x+r,y);c.arcTo(x+w,y,x+w,y+h,r);
c.arcTo(x+w,y+h,x,y+h,r);c.arcTo(x,y+h,x,y,r);c.arcTo(x,y,x+w,y,r);c.closePath()}
async function capture(){if(!stream)return;let w=video.videoWidth,h=video.videoHeight;
canvas.width=w;canvas.height=h;let ctx=canvas.getContext("2d");ctx.drawImage(video,0,0,w,h);
let lines=[];if(inclTS.checked){let t=ts();lines.push(`Date: ${t.date}  Time: ${t.time}`)}
if(lastPos&&inclLoc.checked){lines.push(`Lat:${lastPos.coords.latitude.toFixed(6)} Lon:${lastPos.coords.longitude.toFixed(6)} Acc:${Math.round(lastPos.coords.accuracy)}m`);
if(lastPlace)lines.push(`Place:${lastPlace.place} PIN:${lastPlace.pin}`)}
if(noteE.value)lines.push("Note: "+noteE.value);
ctx.fillStyle="rgba(0,0,0,.4)";roundRect(ctx,8,h-(lines.length*20+20),w-16,lines.length*20+16,8);ctx.fill();
ctx.fillStyle="#fff";ctx.font="14px sans-serif";lines.forEach((l,i)=>ctx.fillText(l,16,h-(lines.length*20)+i*20));
video.style.display="none";canvas.style.display="block";dBtn.disabled=!1}
function download(){canvas.toBlob(b=>{let u=URL.createObjectURL(b),a=document.createElement("a");
a.href=u;a.download="photo.jpg";a.click();URL.revokeObjectURL(u)},"image/jpeg",.9)}
sBtn.onclick=startCam;stopBtn.onclick=()=>{stopCam();video.style.display="block";canvas.style.display="none"};cBtn.onclick=capture;
gBtn.onclick=getLoc;dBtn.onclick=download;

/* Manifest + SW inline */
const manifest={name:"ShriCam",short_name:"ShriCam",start_url:".",display:"standalone",background_color:"#fff",theme_color:"#086788"};
const blob=new Blob([JSON.stringify(manifest)],{type:"application/json"});
document.getElementById("manifest-placeholder").setAttribute("href",URL.createObjectURL(blob));
if("serviceWorker"in navigator){navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
self.addEventListener('install',e=>e.waitUntil(caches.open('shricam').then(c=>c.addAll(['./']))));
self.addEventListener('fetch',e=>e.respondWith(fetch(e.request).catch(()=>caches.match('./'))));
`],{type:"text/javascript"}))).catch(console.warn);}
</script>
</body>
</html>
